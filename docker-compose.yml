services:
  forge:
    build:
      context: .
      target: runtime
    image: forge:local
    profiles: ["prod"]
    ports:
      - "3141:3141"
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - CLAUDE_CODE_OAUTH_TOKEN=${CLAUDE_CODE_OAUTH_TOKEN:-}
      - CLAUDE_CMD=${CLAUDE_CMD:-claude}
      - FORGE_CMD=${FORGE_CMD:-forge}
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID:-}
      - FORGE_SANDBOX=${FORGE_SANDBOX:-false}
    volumes:
      - .:/app/project
      - /var/run/docker.sock:/var/run/docker.sock
    working_dir: /app/project
    command: ["factory", "--port", "3141"]

  forge-dev:
    build:
      context: .
      target: dev
    profiles: ["dev"]
    ports:
      - "3141:3141"
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - CLAUDE_CODE_OAUTH_TOKEN=${CLAUDE_CODE_OAUTH_TOKEN:-}
      - CLAUDE_CMD=${CLAUDE_CMD:-claude}
      - FORGE_CMD=${FORGE_CMD:-forge}
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID:-}
      - FORGE_SANDBOX=${FORGE_SANDBOX:-false}
      - RUST_LOG=debug
    volumes:
      - .:/app
      - cargo-cache:/usr/local/cargo/registry
      - cargo-target:/app/target
      - /var/run/docker.sock:/var/run/docker.sock
    command: ["cargo", "watch", "-i", ".forge/", "-x", "run -- factory --dev --port 3141"]

  ui-dev:
    image: node:22-alpine
    profiles: ["dev"]
    working_dir: /app
    ports:
      - "5173:5173"
    environment:
      - API_HOST=forge-dev
    depends_on:
      - forge-dev
    volumes:
      - ./ui:/app
      - node-modules:/app/node_modules
    command: ["sh", "-c", "npm install && npm run dev -- --host 0.0.0.0"]

volumes:
  cargo-cache:
  cargo-target:
  node-modules:
